{% extends 'base.html' %}

{% block title %}Productos - La Casa del Gadget{% endblock %}

{% block content %}
<div class="productos-page" style="padding: 10px 0;">
  <h1 style="margin: 0 0 18px 0;">Productos</h1>

  <div style="display:flex; gap:30px; align-items:flex-start;">

    <!-- Filtros -->
   <aside class="filtros-card"
  style="
    background:#fff;
    border-radius:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    padding:22px 18px;
    min-width:260px;

    /* ✅ ESTO ES LO QUE LO ARREGLA */
    max-height: calc(100vh - 140px);
    overflow: auto;

    /* sticky opcional: si te molesta, bórralo */
    position: sticky;
    top: 90px;
  "
>
  <h2 style="font-size:1.1rem; margin:0 0 14px 0; text-align:center;">Filtros</h2>

  <form method="get" action="{{ url_for('main.productos_listado') }}"
        style="display:flex; flex-direction:column; gap:18px;">

    <!-- Buscar -->
    <div style="display:flex; flex-direction:column; gap:8px;">
      <label style="font-weight:700;">Buscar</label>
      <input
        type="text"
        name="q"
        placeholder="Nombre o marca..."
        value="{{ filtros.q if filtros and filtros.q else '' }}"
        style="width:100%; padding:10px 12px; border:1px solid rgba(0,0,0,0.12); border-radius:10px;"
      />
    </div>

    <!-- Categoría -->
    <div style="display:flex; flex-direction:column; gap:10px;">
      <div style="font-weight:700;">Categoría</div>

      {% set cats = filtros.categorias if filtros and filtros.categorias else [] %}
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" name="categoria" value="telefonos" {% if 'telefonos' in cats %}checked{% endif %}>
        <span>Teléfonos</span>
      </label>
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" name="categoria" value="tablets" {% if 'tablets' in cats %}checked{% endif %}>
        <span>Tablets</span>
      </label>
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" name="categoria" value="laptops" {% if 'laptops' in cats %}checked{% endif %}>
        <span>Laptops</span>
      </label>
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" name="categoria" value="accesorios" {% if 'accesorios' in cats %}checked{% endif %}>
        <span>Accesorios</span>
      </label>
    </div>

    <!-- Marca -->
    <div style="display:flex; flex-direction:column; gap:10px;">
      <div style="font-weight:700;">Marca</div>

      {% set marcas = filtros.marcas if filtros and filtros.marcas else [] %}

      {% if ui_data and ui_data.marcas_disponibles %}
        {% for m in ui_data.marcas_disponibles %}
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" name="marca" value="{{ m }}" {% if m in marcas %}checked{% endif %}>
            <span>{{ m }}</span>
          </label>
        {% endfor %}
      {% else %}
        <!-- fallback -->
        {% for m in ['Apple','Samsung','Xiaomi','Google'] %}
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" name="marca" value="{{ m }}" {% if m in marcas %}checked{% endif %}>
            <span>{{ m }}</span>
          </label>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Precio -->
    <div style="display:flex; flex-direction:column; gap:10px;">
      <div style="font-weight:700;">Precio máximo</div>

      {% set max_real = (ui_data.max_precio_real if ui_data and ui_data.max_precio_real else 50000) %}
      {% set precio_val = (filtros.precio_max if filtros and filtros.precio_max is not none else max_real) %}

      <input id="precio_max" type="range" name="precio_max"
             min="0" max="{{ max_real }}" step="100"
             value="{{ precio_val }}"/>

      <div style="display:flex; justify-content:space-between; color:#555; font-size:0.9rem;">
        <span>$0</span>
        <span id="precio_max_label"></span>
      </div>
    </div>

    <!-- ✅ BOTONES (ya visibles porque el panel scrollea) -->
    <div style="display:flex; gap:12px;">
      <button type="submit"
        style="flex:1; background:#14532d; color:#fff; border:none; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer;">
        Filtrar
      </button>

      <a href="{{ url_for('main.productos_listado') }}"
        style="flex:1; text-align:center; text-decoration:none; color:#14532d; font-weight:700; border:1px solid rgba(20,83,45,0.25); padding:10px 12px; border-radius:10px;">
        Limpiar
      </a>
    </div>
  </form>
</aside>

<script>
  const slider = document.getElementById("precio_max");
  const label = document.getElementById("precio_max_label");
  function fmt(n){ return new Intl.NumberFormat("es-MX").format(Number(n||0)); }
  function upd(){ if(slider && label) label.textContent = "$" + fmt(slider.value); }
  upd(); if(slider) slider.addEventListener("input", upd);
</script>


    <!-- Grid de productos -->
    <section style="flex:1;">
      <div style="margin-bottom:12px; color:#666;">
        {{ productos|length }} productos encontrados
      </div>

      <div class="products-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:28px;">
        {% for producto in productos %}
          <div class="product-card" style="background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:18px;">
            <img
              src="{{ producto.url_imagen }}"
              alt="{{ producto.nombre }}"
              style="width:100%; height:180px; object-fit:cover; border-radius:10px; background:#f3f4f6;"
              onerror="this.src='https://via.placeholder.com/600x400?text=Sin+Imagen';"
            >

            <div style="margin-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <span style="color:#888; font-size:0.95rem;">{{ producto.marca }}</span>
                {% if producto.tipo %}
                  <span style="font-size:0.8rem; color:#6b7280; background:#f3f4f6; padding:4px 8px; border-radius:999px;">
                    {{ producto.tipo }}
                  </span>
                {% endif %}
              </div>

              <h3 style="margin:8px 0 10px 0; font-size:1.1rem; line-height:1.2;">
                {{ producto.nombre }}
              </h3>

              <p style="font-weight:800; color:var(--verde); font-size:1.2rem; margin:0;">
                ${{ "{:,.0f}".format(producto.precio) }}
              </p>
            </div>

            <form method="POST" action="{{ url_for('main.agregar_carrito', producto_id=producto.id) }}">
              <button type="submit" class="btn-submit" style="width:100%; margin-top:12px;">
                <i class="fas fa-shopping-cart"></i> Agregar al carrito
              </button>
            </form>
          </div>
        {% else %}
          <div style="grid-column:1/-1; text-align:center; color:#888; padding:25px 0;">
            No se encontraron productos con esos filtros.
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<script>
  const slider = document.getElementById("precio_max");
  const label = document.getElementById("precio_max_label");

  function formatMoney(n){
    return new Intl.NumberFormat("es-MX").format(Number(n || 0));
  }

  function updateLabel(){
    if (!slider || !label) return;
    label.textContent = "$" + formatMoney(slider.value);
  }

  updateLabel();
  if (slider) slider.addEventListener("input", updateLabel);
</script>
{% endblock %}


.logout-btn {
  background: rgba(217, 119, 82, 0.15);
  color: #D97752;
}
.logout-btn:hover {
  background: #D97752;
  color: #fff;
}
